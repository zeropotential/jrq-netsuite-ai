<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NetSuite AI Chat</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #eef3f6;
        --sidebar: #ffffff;
        --sidebar-text: #0f172a;
        --sidebar-muted: #64748b;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #6b7280;
        --accent: #0f766e;
        --accent-2: #22c1a2;
        --card: #f7fafc;
        --border: #e5e7eb;
        --shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
        --soft: #f1f5f9;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
        gap: 16px;
        padding: 18px;
      }
      .sidebar {
        background: var(--sidebar);
        color: var(--sidebar-text);
        padding: 18px 14px;
        display: flex;
        flex-direction: column;
        gap: 18px;
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 18px;
      }
      .brand-dot {
        width: 16px;
        height: 16px;
        border-radius: 6px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
      }
      .nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .nav-item {
        padding: 10px 12px;
        border-radius: 10px;
        color: var(--sidebar-text);
        cursor: pointer;
        font-size: 14px;
        background: transparent;
      }
      .nav-item.active,
      .nav-item:hover {
        background: var(--soft);
      }
      .nav-section {
        margin-top: 10px;
        font-size: 12px;
        color: var(--sidebar-muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      .main {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .topbar {
        background: #0f766e;
        border-radius: 16px;
        padding: 14px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow);
        color: white;
      }
      .topbar h1 {
        margin: 0;
        font-size: 18px;
        color: white;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }
      .panel {
        background: var(--panel);
        border-radius: 16px;
        padding: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .inputs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
      }
      .hidden {
        display: none !important;
      }
      .login-screen {
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: var(--bg);
      }
      .login-card {
        width: min(520px, 92vw);
        background: var(--panel);
        border-radius: 18px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        padding: 22px;
      }
      .login-card h2 {
        margin: 0 0 8px 0;
        font-size: 20px;
      }
      .login-card p {
        margin: 0 0 16px 0;
        color: var(--muted);
        font-size: 14px;
      }
      .login-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 12px;
      }
      .field-error {
        color: #b91c1c;
        font-size: 12px;
        margin-top: 4px;
      }
      .input-error {
        border-color: #ef4444 !important;
        background: #fef2f2;
      }
      .notice {
        font-size: 12px;
        color: var(--muted);
      }
      .chat-only .inputs,
      .chat-only #runReportBtn,
      .chat-only #exportCsvBtn,
      .chat-only #exportXlsxBtn,
      .chat-only #exportPdfBtn,
      .chat-only .footer {
        display: none !important;
      }
      .kb-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        background: var(--card);
        margin-top: 12px;
      }
      .kb-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 12px;
      }
      .kb-item {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
      }
      .kb-item small {
        color: var(--muted);
        display: block;
        margin-top: 6px;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      input, textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        font-size: 14px;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        background: var(--accent);
        color: white;
        font-weight: 600;
        cursor: pointer;
        font-size: 13px;
      }
      .btn-secondary {
        background: #e2e8f0;
        color: #0f172a;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .chat {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .message {
        padding: 14px;
        background: #f8fafc;
        border-radius: 14px;
        line-height: 1.6;
        border: 1px solid var(--border);
      }
      .message .content {
        white-space: pre-wrap;
        word-break: break-word;
      }
      .message-row {
        display: grid;
        grid-template-columns: 36px 1fr;
        gap: 12px;
        align-items: flex-start;
      }
      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        color: #0f172a;
      }
      .avatar.assistant {
        background: linear-gradient(135deg, #0f766e, #22c1a2);
        color: white;
      }
      .avatar.user {
        background: #e0f2fe;
        color: #0369a1;
      }
      .message-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }
      .message strong {
        display: inline-block;
        margin-bottom: 6px;
        color: #0f172a;
      }
      .message small {
        display: block;
        margin-top: 8px;
        color: var(--muted);
      }
      .footer {
        margin-top: 12px;
        font-size: 12px;
        color: var(--muted);
      }
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          display: none;
        }
        .inputs {
          grid-template-columns: 1fr;
        }
      }
      /* Thinking animation */
      .thinking {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .thinking-dots {
        display: flex;
        gap: 4px;
      }
      .thinking-dots span {
        width: 8px;
        height: 8px;
        background: var(--accent);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }
      .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
      .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
      .thinking-dots span:nth-child(3) { animation-delay: 0s; }
      @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
      /* Typing cursor */
      .typing-cursor {
        display: inline-block;
        width: 2px;
        height: 1em;
        background: var(--accent);
        margin-left: 2px;
        animation: blink 1s infinite;
        vertical-align: text-bottom;
      }
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
      /* Visualization container */
      .viz-container {
        margin-top: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
      }
      .viz-container iframe {
        width: 100%;
        min-height: 400px;
        border: none;
        display: block;
      }
      .viz-toggle {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .viz-toggle button {
        padding: 6px 12px;
        font-size: 12px;
        background: var(--soft);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .viz-toggle button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div id="loginScreen" class="login-screen">
      <div class="login-card">
        <h2>Connect to NetSuite</h2>
        <p>Enter your Connection ID and OpenAI API Key to start chatting.</p>
        <label>
          Connection ID
          <input id="loginConnectionId" placeholder="" />
          <span id="loginConnectionError" class="field-error"></span>
        </label>
        <label>
          OpenAI API Key
          <input id="loginOpenaiKey" type="password" placeholder="sk-..." autocomplete="off" />
          <span id="loginOpenaiError" class="field-error"></span>
        </label>
        <div class="notice">Keys are used only in your browser session and sent to the API on each request.</div>
        <div class="login-actions">
          <button id="loginBtn">Continue</button>
          <span id="loginStatus" class="footer"></span>
        </div>
      </div>
    </div>

    <div id="app" class="layout hidden">
      <aside class="sidebar">
        <div class="brand">
          <span class="brand-dot"></span>
          NetSuite AI
        </div>
        <div class="nav">
          <div class="nav-item active" data-view="chat">Chat Workspace</div>
          <div class="nav-item" data-view="reports">Reports</div>
          <div class="nav-item" data-view="connections">Connections</div>
          <div class="nav-item" data-view="kb">Knowledge Base</div>
          <div class="nav-section">Recent</div>
          <div class="nav-item">Revenue Insights</div>
          <div class="nav-item">AP Aging</div>
          <div class="nav-item">Inventory Turns</div>
        </div>
      </aside>
      <main class="main">
        <div class="topbar">
          <div>
            <h1 id="viewTitle">Chat Workspace</h1>
            <div class="badge" id="viewBadge">General assistant</div>
          </div>
          <div class="badge">NetSuite SuiteAnalytics</div>
        </div>

        <section class="panel" id="chatView">
          <div class="inputs">
            <label>
              JDBC Connection ID
              <input id="connectionId" placeholder="UUID from /admin/jdbc-connections" />
              <span id="connectionError" class="field-error"></span>
            </label>
            <label>
              Schema Hint (optional)
              <input id="scope" placeholder="Table names, fields, joins" />
            </label>
            <label>
              OpenAI API Key (runtime only)
              <input id="openaiKey" type="password" placeholder="sk-..." autocomplete="off" />
              <span id="openaiError" class="field-error"></span>
            </label>
          </div>
          <label>
            Ask a question or provide SQL
            <textarea id="message" placeholder="Example: total sales by month for 2024"></textarea>
          </label>
          <div class="actions" style="margin-top: 10px;">
            <button id="sendBtn">Send</button>
            <button id="clearChatBtn" class="btn-secondary">Clear Chat</button>
            <button id="runReportBtn" class="btn-secondary">Run Report</button>
            <button id="exportCsvBtn" class="btn-secondary">Export CSV</button>
            <button id="exportXlsxBtn" class="btn-secondary">Export Excel</button>
            <button id="exportPdfBtn" class="btn-secondary">Export PDF</button>
            <span id="status" class="footer"></span>
          </div>

          <div class="chat" id="chat"></div>
          <div class="footer">
            Endpoints: <strong>/api/chat</strong>, <strong>/api/report/run</strong>, <strong>/api/report/export/*</strong>
          </div>
          <div class="chat" id="report"></div>
        </section>

        <section class="panel hidden" id="kbView">
          <h3 style="margin:0 0 6px 0;">Knowledge Base</h3>
          <p class="footer" style="margin-top:0;">Add notes your assistant can reference. This is stored locally in the browser for now.</p>
          <div class="kb-card">
            <label>
              Title
              <input id="kbTitle" placeholder="e.g., Revenue Recognition Policy" />
            </label>
            <label>
              Content
              <textarea id="kbContent" placeholder="Paste your guidance, SOPs, or domain knowledge..."></textarea>
            </label>
            <div class="actions" style="margin-top:8px;">
              <button id="kbAddBtn">Add to Knowledge Base</button>
              <button id="kbClearBtn" class="btn-secondary">Clear All</button>
              <span id="kbStatus" class="footer"></span>
            </div>
          </div>
          <div class="kb-list" id="kbList"></div>
        </section>

        <section class="panel hidden" id="connectionsView">
          <h3 style="margin:0 0 6px 0;">Connection Status</h3>
          <p class="footer" style="margin-top:0;">View the health status of your database and API connections.</p>
          
          <div class="actions" style="margin-bottom: 16px;">
            <button id="refreshConnectionsBtn">Refresh Status</button>
            <span id="connectionsStatus" class="footer"></span>
          </div>

          <div class="connection-cards" style="display: flex; flex-direction: column; gap: 16px;">
            <!-- NetSuite JDBC Card -->
            <div class="kb-card" id="jdbcCard">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <div class="status-indicator" id="jdbcStatusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #6b7280;"></div>
                <strong style="font-size: 16px;">NetSuite Database (JDBC)</strong>
                <span id="jdbcStatusBadge" class="status-badge" style="padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; background: #e2e8f0; color: #475569;">Checking...</span>
              </div>
              <div class="connection-details" id="jdbcDetails" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="detail-item">
                  <span style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em;">Connection Name</span>
                  <div id="jdbcName" style="font-size: 14px; margin-top: 4px;">—</div>
                </div>
                <div class="detail-item">
                  <span style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em;">Account ID</span>
                  <div id="jdbcAccountId" style="font-size: 14px; margin-top: 4px;">—</div>
                </div>
                <div class="detail-item">
                  <span style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em;">Host</span>
                  <div id="jdbcHost" style="font-size: 14px; margin-top: 4px;">—</div>
                </div>
                <div class="detail-item">
                  <span style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em;">Role ID</span>
                  <div id="jdbcRoleId" style="font-size: 14px; margin-top: 4px;">—</div>
                </div>
              </div>
              <div id="jdbcError" style="color: #b91c1c; font-size: 13px; margin-top: 10px; display: none;"></div>
            </div>

            <!-- OpenAI API Card -->
            <div class="kb-card" id="openaiCard">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <div class="status-indicator" id="openaiStatusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #6b7280;"></div>
                <strong style="font-size: 16px;">OpenAI API</strong>
                <span id="openaiStatusBadge" class="status-badge" style="padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 600; background: #e2e8f0; color: #475569;">Checking...</span>
              </div>
              <div class="connection-details" id="openaiDetails">
                <div class="detail-item">
                  <span style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em;">Model</span>
                  <div id="openaiModel" style="font-size: 14px; margin-top: 4px;">—</div>
                </div>
              </div>
              <div id="openaiError" style="color: #b91c1c; font-size: 13px; margin-top: 10px; display: none;"></div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const sendBtn = document.getElementById("sendBtn");
      const statusEl = document.getElementById("status");
      const chatEl = document.getElementById("chat");
      const reportEl = document.getElementById("report");
      const runReportBtn = document.getElementById("runReportBtn");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      const exportXlsxBtn = document.getElementById("exportXlsxBtn");
      const exportPdfBtn = document.getElementById("exportPdfBtn");
      const openaiKeyEl = document.getElementById("openaiKey");
      const clearChatBtn = document.getElementById("clearChatBtn");
      const loginScreen = document.getElementById("loginScreen");
      const appEl = document.getElementById("app");
      const loginBtn = document.getElementById("loginBtn");
      const loginStatus = document.getElementById("loginStatus");
      const loginConnectionId = document.getElementById("loginConnectionId");
      const loginOpenaiKey = document.getElementById("loginOpenaiKey");
      const chatView = document.getElementById("chatView");
      const kbView = document.getElementById("kbView");
      const viewTitle = document.getElementById("viewTitle");
      const viewBadge = document.getElementById("viewBadge");
      const kbTitle = document.getElementById("kbTitle");
      const kbContent = document.getElementById("kbContent");
      const kbAddBtn = document.getElementById("kbAddBtn");
      const kbClearBtn = document.getElementById("kbClearBtn");
      const kbList = document.getElementById("kbList");
      const kbStatus = document.getElementById("kbStatus");
      const loginConnectionError = document.getElementById("loginConnectionError");
      const loginOpenaiError = document.getElementById("loginOpenaiError");
      const connectionError = document.getElementById("connectionError");
      const openaiError = document.getElementById("openaiError");
      const connectionsView = document.getElementById("connectionsView");
      const refreshConnectionsBtn = document.getElementById("refreshConnectionsBtn");
      const connectionsStatus = document.getElementById("connectionsStatus");

      // Session-based chat history (clears on page refresh)
      let chatHistory = [];
      let kbItems = [];

      const loadKb = () => {
        try {
          const stored = localStorage.getItem("netsuite_kb_items");
          kbItems = stored ? JSON.parse(stored) : [];
        } catch {
          kbItems = [];
        }
        renderKb();
      };

      const saveKb = () => {
        localStorage.setItem("netsuite_kb_items", JSON.stringify(kbItems));
      };

      const renderKb = () => {
        kbList.innerHTML = "";
        if (!kbItems.length) {
          const empty = document.createElement("div");
          empty.className = "kb-item";
          empty.textContent = "No knowledge base entries yet.";
          kbList.appendChild(empty);
          return;
        }
        kbItems.forEach((item) => {
          const div = document.createElement("div");
          div.className = "kb-item";
          div.innerHTML = `<strong>${item.title}</strong><div>${item.content}</div><small>${new Date(item.createdAt).toLocaleString()}</small>`;
          kbList.appendChild(div);
        });
      };

      const setView = (view) => {
        document.querySelectorAll(".nav-item").forEach((el) => {
          el.classList.toggle("active", el.dataset.view === view);
        });
        // Hide all views first
        chatView.classList.add("hidden");
        kbView.classList.add("hidden");
        connectionsView.classList.add("hidden");
        
        if (view === "kb") {
          kbView.classList.remove("hidden");
          viewTitle.textContent = "Knowledge Base";
          viewBadge.textContent = "Notes & Context";
          loadKb();
        } else if (view === "connections") {
          connectionsView.classList.remove("hidden");
          viewTitle.textContent = "Connections";
          viewBadge.textContent = "Health Status";
          checkConnectionsHealth();
        } else {
          chatView.classList.remove("hidden");
          viewTitle.textContent = "Chat Workspace";
          viewBadge.textContent = "General assistant";
        }
      };

      document.querySelectorAll(".nav-item").forEach((el) => {
        el.addEventListener("click", () => {
          const view = el.dataset.view || "chat";
          setView(view);
        });
      });

      kbAddBtn?.addEventListener("click", () => {
        kbStatus.textContent = "";
        const title = kbTitle.value.trim();
        const content = kbContent.value.trim();
        if (!title || !content) {
          kbStatus.textContent = "Title and content are required.";
          return;
        }
        kbItems.unshift({
          title,
          content,
          createdAt: new Date().toISOString(),
        });
        saveKb();
        renderKb();
        kbTitle.value = "";
        kbContent.value = "";
        kbStatus.textContent = "Added.";
        setTimeout(() => (kbStatus.textContent = ""), 1500);
      });

      kbClearBtn?.addEventListener("click", () => {
        kbItems = [];
        saveKb();
        renderKb();
        kbStatus.textContent = "Cleared.";
        setTimeout(() => (kbStatus.textContent = ""), 1500);
      });

      // Connections health check
      const updateStatusUI = (indicator, badge, status) => {
        if (status === "connected") {
          indicator.style.background = "#22c55e";
          badge.style.background = "#dcfce7";
          badge.style.color = "#166534";
          badge.textContent = "Connected";
        } else if (status === "error") {
          indicator.style.background = "#ef4444";
          badge.style.background = "#fef2f2";
          badge.style.color = "#b91c1c";
          badge.textContent = "Error";
        } else {
          indicator.style.background = "#6b7280";
          badge.style.background = "#e2e8f0";
          badge.style.color = "#475569";
          badge.textContent = "Checking...";
        }
      };

      const checkConnectionsHealth = async () => {
        const connectionId = document.getElementById("connectionId").value.trim();
        const apiKey = openaiKeyEl.value.trim();

        if (!connectionId) {
          connectionsStatus.textContent = "No connection ID configured. Please log in first.";
          return;
        }

        // Reset UI to checking state
        const jdbcIndicator = document.getElementById("jdbcStatusIndicator");
        const jdbcBadge = document.getElementById("jdbcStatusBadge");
        const openaiIndicator = document.getElementById("openaiStatusIndicator");
        const openaiBadge = document.getElementById("openaiStatusBadge");
        updateStatusUI(jdbcIndicator, jdbcBadge, "checking");
        updateStatusUI(openaiIndicator, openaiBadge, "checking");
        document.getElementById("jdbcError").style.display = "none";
        document.getElementById("openaiError").style.display = "none";
        connectionsStatus.textContent = "Checking connections...";
        refreshConnectionsBtn.disabled = true;

        try {
          const headers = { "Content-Type": "application/json" };
          if (apiKey) {
            headers["X-OpenAI-Api-Key"] = apiKey;
          }

          const response = await fetch("/api/connections/health", {
            method: "POST",
            headers,
            body: JSON.stringify({ connection_id: connectionId }),
          });

          if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(errData.detail || `Request failed with status ${response.status}`);
          }

          const data = await response.json();

          // Update JDBC status
          updateStatusUI(jdbcIndicator, jdbcBadge, data.jdbc.status);
          document.getElementById("jdbcName").textContent = data.jdbc.name || "—";
          document.getElementById("jdbcAccountId").textContent = data.jdbc.account_id || "—";
          document.getElementById("jdbcHost").textContent = data.jdbc.host || "—";
          document.getElementById("jdbcRoleId").textContent = data.jdbc.role_id || "—";
          if (data.jdbc.error) {
            const jdbcErrorEl = document.getElementById("jdbcError");
            jdbcErrorEl.textContent = data.jdbc.error;
            jdbcErrorEl.style.display = "block";
          }

          // Update OpenAI status
          updateStatusUI(openaiIndicator, openaiBadge, data.openai.status);
          document.getElementById("openaiModel").textContent = data.openai.model || "—";
          if (data.openai.error) {
            const openaiErrorEl = document.getElementById("openaiError");
            openaiErrorEl.textContent = data.openai.error;
            openaiErrorEl.style.display = "block";
          }

          connectionsStatus.textContent = "";
        } catch (err) {
          connectionsStatus.textContent = err.message;
          updateStatusUI(jdbcIndicator, jdbcBadge, "error");
          updateStatusUI(openaiIndicator, openaiBadge, "error");
        } finally {
          refreshConnectionsBtn.disabled = false;
        }
      };

      refreshConnectionsBtn?.addEventListener("click", checkConnectionsHealth);

      const clearErrors = () => {
        loginStatus.textContent = "";
        loginConnectionError.textContent = "";
        loginOpenaiError.textContent = "";
        connectionError.textContent = "";
        openaiError.textContent = "";
        loginConnectionId.classList.remove("input-error");
        loginOpenaiKey.classList.remove("input-error");
        document.getElementById("connectionId").classList.remove("input-error");
        openaiKeyEl.classList.remove("input-error");
      };

      const validateConnectionId = (value) => {
        // Basic UUID format check
        return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(value.trim());
      };

      const validateOpenAiKey = (value) => {
        return value.trim().startsWith("sk-") && value.trim().length >= 20;
      };

      const applyLogin = () => {
        clearErrors();
        const connectionId = loginConnectionId.value.trim();
        const openaiKey = loginOpenaiKey.value.trim();
        let hasError = false;
        if (!connectionId) {
          loginConnectionError.textContent = "JDBC Connection ID is required.";
          loginConnectionId.classList.add("input-error");
          hasError = true;
        } else if (!validateConnectionId(connectionId)) {
          loginConnectionError.textContent = "Invalid Connection ID format (UUID).";
          loginConnectionId.classList.add("input-error");
          hasError = true;
        }
        if (!openaiKey) {
          loginOpenaiError.textContent = "OpenAI API Key is required.";
          loginOpenaiKey.classList.add("input-error");
          hasError = true;
        } else if (!validateOpenAiKey(openaiKey)) {
          loginOpenaiError.textContent = "Invalid API key format.";
          loginOpenaiKey.classList.add("input-error");
          hasError = true;
        }
        if (hasError) {
          loginStatus.textContent = "Please fix the highlighted fields.";
          return;
        }
        document.getElementById("connectionId").value = connectionId;
        openaiKeyEl.value = openaiKey;
        // Show app, hide login
        loginScreen.classList.add("hidden");
        appEl.classList.remove("hidden");
        // Chat-only view
        document.body.classList.add("chat-only");
        setView("chat");
      };

      loginBtn.addEventListener("click", applyLogin);
      loginOpenaiKey.addEventListener("keydown", (e) => {
        if (e.key === "Enter") applyLogin();
      });

      // Clear chat button handler
      clearChatBtn.addEventListener("click", () => {
        chatHistory = [];
        chatEl.innerHTML = "";
        statusEl.textContent = "Chat cleared. Memory reset.";
        setTimeout(() => { statusEl.textContent = ""; }, 2000);
      });

      const addMessage = (label, text, source) => {
        const div = document.createElement("div");
        const isAssistant = label.toLowerCase() === "assistant";
        const avatarClass = isAssistant ? "assistant" : "user";
        const avatarText = isAssistant ? "AI" : "U";
        div.className = "message";
        div.innerHTML = `
          <div class="message-row">
            <div class="avatar ${avatarClass}">${avatarText}</div>
            <div>
              <div class="message-header"><strong>${label}</strong></div>
              <div class="content"></div>
              ${source ? `<small>${source}</small>` : ""}
            </div>
          </div>
        `;
        const contentEl = div.querySelector(".content");
        if (contentEl) contentEl.textContent = text;
        chatEl.prepend(div);
        return div;
      };

      // Add thinking indicator
      const addThinkingIndicator = () => {
        const div = document.createElement("div");
        div.className = "message";
        div.id = "thinking-indicator";
        div.innerHTML = `
          <div class="message-row">
            <div class="avatar assistant">AI</div>
            <div>
              <div class="message-header"><strong>Assistant</strong></div>
              <div class="thinking">
                <span>Thinking</span>
                <div class="thinking-dots">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          </div>
        `;
        chatEl.prepend(div);
        return div;
      };

      // Remove thinking indicator
      const removeThinkingIndicator = () => {
        const indicator = document.getElementById("thinking-indicator");
        if (indicator) indicator.remove();
      };

      // Typing effect function
      const typeText = async (element, text, speed = 15) => {
        const contentDiv = element.querySelector(".content");
        contentDiv.innerHTML = "";
        
        // For data tables (contains pipes), show instantly
        if (text.includes(" | ") && text.includes("\n")) {
          contentDiv.textContent = text;
          return;
        }
        
        // Add cursor
        const cursor = document.createElement("span");
        cursor.className = "typing-cursor";
        contentDiv.appendChild(cursor);
        
        // Type character by character
        let i = 0;
        const chars = text.split("");
        
        return new Promise((resolve) => {
          const typeChar = () => {
            if (i < chars.length) {
              // Insert text before cursor
              const textNode = document.createTextNode(chars[i]);
              contentDiv.insertBefore(textNode, cursor);
              
              // Handle newlines
              if (chars[i] === "\n") {
                const br = document.createElement("br");
                contentDiv.insertBefore(br, cursor);
              }
              
              i++;
              // Vary speed slightly for more natural feel
              const delay = chars[i-1] === "." || chars[i-1] === "!" || chars[i-1] === "?" ? speed * 3 : speed;
              setTimeout(typeChar, delay);
            } else {
              // Remove cursor when done
              cursor.remove();
              resolve();
            }
          };
          typeChar();
        });
      };

      // Add message with typing effect
      const addMessageWithTyping = async (label, text, source) => {
        const div = document.createElement("div");
        const isAssistant = label.toLowerCase() === "assistant";
        const avatarClass = isAssistant ? "assistant" : "user";
        const avatarText = isAssistant ? "AI" : "U";
        div.className = "message";
        div.innerHTML = `
          <div class="message-row">
            <div class="avatar ${avatarClass}">${avatarText}</div>
            <div>
              <div class="message-header"><strong>${label}</strong></div>
              <div class="content"></div>
              ${source ? `<small>${source}</small>` : ""}
            </div>
          </div>
        `;
        chatEl.prepend(div);
        await typeText(div, text);
        // Re-add source after typing (in case it was cleared)
        if (source) {
          const small = div.querySelector("small");
          if (small) small.innerHTML = source;
        }
        return div;
      };

      // Add message with HTML visualization (charts, tables, graphs)
      const addMessageWithVisualization = async (label, text, source, html) => {
        const vizId = "viz-" + Date.now();
        const div = document.createElement("div");
        const isAssistant = label.toLowerCase() === "assistant";
        const avatarClass = isAssistant ? "assistant" : "user";
        const avatarText = isAssistant ? "AI" : "U";
        div.className = "message";
        div.innerHTML = `
          <div class="message-row">
            <div class="avatar ${avatarClass}">${avatarText}</div>
            <div style="flex:1;min-width:0;">
              <div class="message-header"><strong>${label}</strong></div>
              <div class="viz-toggle">
                <button class="active" data-view="viz">Dashboard</button>
                <button data-view="text">Raw Data</button>
              </div>
              <div class="viz-container" id="${vizId}-viz">
                <iframe sandbox="allow-scripts" srcdoc=""></iframe>
              </div>
              <div class="content" id="${vizId}-text" style="display:none;"></div>
              ${source ? `<small>${source}</small>` : ""}
            </div>
          </div>
        `;
        chatEl.prepend(div);
        
        // Set iframe content
        const iframe = div.querySelector("iframe");
        iframe.srcdoc = html;
        
        // Auto-resize iframe after content loads
        iframe.onload = () => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const height = iframeDoc.body.scrollHeight + 20;
            iframe.style.height = Math.min(Math.max(height, 300), 800) + "px";
          } catch (e) {
            // Sandbox may prevent access, use default height
            iframe.style.height = "500px";
          }
        };
        
        // Set text content
        const textDiv = div.querySelector(`#${vizId}-text`);
        textDiv.textContent = text;
        
        // Toggle buttons
        const toggleBtns = div.querySelectorAll(".viz-toggle button");
        const vizContainer = div.querySelector(`#${vizId}-viz`);
        toggleBtns.forEach(btn => {
          btn.addEventListener("click", () => {
            toggleBtns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            if (btn.dataset.view === "viz") {
              vizContainer.style.display = "block";
              textDiv.style.display = "none";
            } else {
              vizContainer.style.display = "none";
              textDiv.style.display = "block";
            }
          });
        });
        
        return div;
      };

      const getPayload = () => {
        clearErrors();
        const connectionId = document.getElementById("connectionId").value.trim();
        const scope = document.getElementById("scope").value.trim();
        const message = document.getElementById("message").value.trim();

        if (!message) {
          statusEl.textContent = "Message is required.";
          return null;
        }

        if (!connectionId) {
          connectionError.textContent = "Connection ID is required.";
          document.getElementById("connectionId").classList.add("input-error");
          return null;
        }
        if (!validateConnectionId(connectionId)) {
          connectionError.textContent = "Invalid Connection ID format (UUID).";
          document.getElementById("connectionId").classList.add("input-error");
          return null;
        }
        const key = openaiKeyEl.value.trim();
        if (!key) {
          openaiError.textContent = "OpenAI API Key is required.";
          openaiKeyEl.classList.add("input-error");
          return null;
        }
        if (!validateOpenAiKey(key)) {
          openaiError.textContent = "Invalid API key format.";
          openaiKeyEl.classList.add("input-error");
          return null;
        }

        return {
          connection_id: connectionId || null,
          prompt: message,
          sql: message.toLowerCase().trim().startsWith("select") || message.toLowerCase().trim().startsWith("with")
            ? message
            : null,
          schema_hint: scope || null,
        };
      };

      const buildHeaders = () => {
        const headers = { "Content-Type": "application/json" };
        const key = openaiKeyEl.value.trim();
        if (key) {
          headers["X-OpenAI-Api-Key"] = key;
        }
        return headers;
      };

      sendBtn.addEventListener("click", async () => {
        const payload = getPayload();
        if (!payload) return;

        statusEl.textContent = "";
        sendBtn.disabled = true;

        addMessage("You", payload.prompt);
        addThinkingIndicator();

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: buildHeaders(),
            body: JSON.stringify({
              message: payload.prompt,
              connection_id: payload.connection_id,
              scope: payload.schema_hint,
              history: chatHistory,
              kb_entries: (kbItems || []).slice(0, 20).map((item) => ({
                title: item.title,
                content: item.content,
              })),
            }),
          });
          
          removeThinkingIndicator();
          
          // Handle non-JSON responses (like "Internal Server Error")
          const contentType = response.headers.get("content-type");
          let data;
          if (contentType && contentType.includes("application/json")) {
            data = await response.json();
          } else {
            const text = await response.text();
            console.error("Non-JSON response:", text);
            throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
          }
          
          if (!response.ok) {
            console.error("API error response:", data);
            throw new Error(data.detail || `Request failed with status ${response.status}`);
          }
          
          // Add to chat history for session memory
          chatHistory.push({ role: "user", content: payload.prompt });
          chatHistory.push({ role: "assistant", content: data.answer });
          // Keep only last 20 messages to avoid token limits
          if (chatHistory.length > 20) {
            chatHistory = chatHistory.slice(-20);
          }
          
          // Build source info - show both source and SQL if available
          let sourceInfo = "";
          if (data.source) {
            sourceInfo = `Source: ${data.source}`;
          }
          if (data.sql) {
            sourceInfo += (sourceInfo ? "<br>" : "") + `<details><summary>View SQL</summary><pre style="background:#1e293b;color:#e2e8f0;padding:8px;border-radius:4px;overflow-x:auto;margin-top:4px;">${data.sql}</pre></details>`;
          }
          
          // Check if we have HTML visualization
          if (data.html) {
            // Add message with visualization
            await addMessageWithVisualization("Assistant", data.answer, sourceInfo, data.html);
          } else {
            // Use typing effect for assistant responses
            await addMessageWithTyping("Assistant", data.answer, sourceInfo);
          }
          statusEl.textContent = "";
          document.getElementById("message").value = "";
        } catch (err) {
          removeThinkingIndicator();
          console.error("Chat error:", err);
          const errorMsg = err.message || "Unknown error occurred";
          statusEl.textContent = errorMsg;
          addMessage("Error", errorMsg, "Check browser console (F12) for details");
        } finally {
          sendBtn.disabled = false;
        }
      });

      const messageEl = document.getElementById("message");
      messageEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      const renderReport = (sql, columns, rows) => {
        reportEl.innerHTML = "";
        const container = document.createElement("div");
        container.className = "message";
        const header = document.createElement("div");
        header.innerHTML = `<strong>Report</strong><div><small>${sql}</small></div>`;
        container.appendChild(header);

        if (!columns.length) {
          const empty = document.createElement("div");
          empty.textContent = "No columns returned.";
          container.appendChild(empty);
          reportEl.appendChild(container);
          return;
        }

        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        columns.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col;
          th.style.textAlign = "left";
          th.style.padding = "6px";
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell;
            td.style.padding = "6px";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
        reportEl.appendChild(container);
      };

      runReportBtn.addEventListener("click", async () => {
        const payload = getPayload();
        if (!payload) return;
        if (!payload.connection_id) {
          statusEl.textContent = "Connection ID is required.";
          return;
        }

        statusEl.textContent = "Running report...";
        try {
          const response = await fetch("/api/report/run", {
            method: "POST",
            headers: buildHeaders(),
            body: JSON.stringify({
              connection_id: payload.connection_id,
              prompt: payload.sql ? null : payload.prompt,
              sql: payload.sql,
              schema_hint: payload.schema_hint,
            }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || "Report failed");
          }
          renderReport(data.sql, data.columns || [], data.rows || []);
          statusEl.textContent = "";
        } catch (err) {
          statusEl.textContent = err.message;
        }
      });

      const exportReport = async (format) => {
        const payload = getPayload();
        if (!payload) return;
        if (!payload.connection_id) {
          statusEl.textContent = "Connection ID is required.";
          return;
        }

        statusEl.textContent = `Exporting ${format.toUpperCase()}...`;
        try {
          const response = await fetch(`/api/report/export/${format}`, {
            method: "POST",
            headers: buildHeaders(),
            body: JSON.stringify({
              connection_id: payload.connection_id,
              prompt: payload.sql ? null : payload.prompt,
              sql: payload.sql,
              schema_hint: payload.schema_hint,
            }),
          });
          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || "Export failed");
          }
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `report.${format}`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          statusEl.textContent = "";
        } catch (err) {
          statusEl.textContent = err.message;
        }
      };

      exportCsvBtn.addEventListener("click", () => exportReport("csv"));
      exportXlsxBtn.addEventListener("click", () => exportReport("xlsx"));
      exportPdfBtn.addEventListener("click", () => exportReport("pdf"));
    </script>
  </body>
</html>
